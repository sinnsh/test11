<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>모바일 웹 · 카메라 + QR 코드 스캔</title>
  <style>
    :root { --bg:#0b1220; --fg:#e6edf3; --muted:#8b98ab; --card:#111a2b; --accent:#3ea6ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif}
    .wrap{max-width:820px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    h1{font-size:16px;margin:0}
    .card{background:var(--card);border-radius:16px;padding:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    video{width:100%;max-height:60vh;background:#000;border-radius:12px}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    button, select{background:var(--accent);color:#061220;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.45;cursor:not-allowed}
    select{color:#fff;background:#222;font-weight:400;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .small{font-size:12px;color:var(--muted)}
    #qr-result{margin-top:8px;color:#3ea6ff;font-weight:700}
  </style>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>카메라 수동 선택 + QR 코드 스캔</h1>
      <div class="row">
        <select id="cameraSelect"></select>
        <button id="btnStart">카메라 시작</button>
        <button id="btnStop" disabled>정지</button>
      </div>
    </header>

    <div class="card" style="margin-top:12px">
      <video id="preview" playsinline autoplay muted></video>
      <div id="qr-result">QR 결과: 없음</div>
      <div class="meta" style="margin-top:8px">
        <div>상태: <span id="status">준비</span></div>
        <div>선택된 카메라: <span id="chosen" class="mono">-</span></div>
      </div>
      <div class="meta" style="margin-top:8px">
        <div>QR 결과: <span id="qrResult" class="mono">-</span></div>
        <div><button id="btnScanToggle">스캔 일시정지</button></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700;margin-bottom:6px">진단</div>
      <div class="meta">
        <div>보안 컨텍스트: <span id="secctx">-</span></div>
        <div>브라우저: <span id="ua">-</span></div>
        <div>권한: <span id="perm">-</span></div>
        <div>오류: <span id="err">-</span></div>
      </div>
      <div class="small" style="margin-top:6px">HTTPS 또는 localhost에서 여세요. 인앱 브라우저는 제한될 수 있습니다.</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
(async function(){
  'use strict';
  const $ = (s)=>document.querySelector(s);
  const els = { video:$('#preview'), status:$('#status'), chosen:$('#chosen'),
                btnStart:$('#btnStart'), btnStop:$('#btnStop'), sel:$('#cameraSelect'),
                sec:$('#secctx'), ua:$('#ua'), perm:$('#perm'), err:$('#err'),
                qrResult:$('#qr-result') };
  const ua = navigator.userAgent || '';
  function setStatus(t){ els.status.textContent = t; }
  function setError(e){ if(!e) return; const msg=[e.name,e.message].filter(Boolean).join(': '); els.err.textContent=msg; console.error(e); }
  els.sec.textContent = (window.isSecureContext ? 'SECURE' : 'NOT SECURE');
  els.ua.textContent = ua;
  try{ const p = await navigator.permissions.query({name:'camera'}); els.perm.textContent=p.state; }catch{ els.perm.textContent='unknown'; }

  let currentStream=null; let scanning=false; let scanRAF=0; const off=document.createElement('canvas'); const offCtx=off.getContext('2d'); let codeReader=null;

  function stopCurrent(){ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } els.video.srcObject=null; els.btnStop.disabled=true; stopScan(); } if(codeReader){ codeReader.reset(); codeReader=null; } els.video.srcObject=null; els.btnStop.disabled=true; setStatus('정지됨'); }

  async function loadCameras(){
    try{
      const list=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
      els.sel.innerHTML='';
      list.forEach((d,i)=>{
        const opt=document.createElement('option');
        opt.value=d.deviceId; opt.textContent=d.label||`camera ${i}`;
        els.sel.appendChild(opt);
      });
      return list;
    }catch(e){ setError(e); return []; }
  }

  async function startSelected(){
    stopCurrent();
    const id=els.sel.value;
    try{
      const constraints={video:{deviceId:{exact:id},facingMode:'environment'},audio:false};
      const stream=await navigator.mediaDevices.getUserMedia(constraints);
      currentStream=stream; els.video.srcObject=stream; await els.video.play();
      els.btnStop.disabled=false; els.chosen.textContent=els.sel.options[els.sel.selectedIndex].text;
      setStatus('실행 중');
      startScan();
    }catch(e){ setError(e); setStatus('실패'); }
  },facingMode:'environment'},audio:false};
      const stream=await navigator.mediaDevices.getUserMedia(constraints);
      currentStream=stream; els.video.srcObject=stream; await els.video.play();
      els.btnStop.disabled=false; els.chosen.textContent=els.sel.options[els.sel.selectedIndex].text;
      setStatus('실행 중');

      // ZXing QR 코드 스캐너 시작
      codeReader = new ZXing.BrowserMultiFormatReader();
      await codeReader.decodeFromVideoDevice(id, els.video, (result,err)=>{
        if(result){ els.qrResult.textContent = 'QR 결과: '+result.getText(); }
        if(err && !(err instanceof ZXing.NotFoundException)){
          console.warn(err);
        }
      });

    }catch(e){ setError(e); setStatus('실패'); }
  }

  els.btnStart.addEventListener('click', startSelected);
  els.btnStop.addEventListener('click', stopCurrent);

  await loadCameras();
  
  // ===== QR 스캔 로직 =====
  function drawOutline(loc){ try{ const ctx=els.video.getContext?els.video.getContext('2d'):null; }catch{}
    // 시각적 오버레이는 생략(필요 시 추가)
  }
  function stopScan(){ scanning=false; if (scanRAF) { cancelAnimationFrame(scanRAF); scanRAF=0; } }
  function startScan(){
    if (!currentStream) return;
    scanning=true; els.qrResult && (els.qrResult.textContent = els.qrResult.textContent || '-');
    const loop = ()=>{
      if (!scanning || !currentStream) return;
      const vw = els.video.videoWidth|0, vh = els.video.videoHeight|0;
      if (vw && vh){
        off.width = vw; off.height = vh;
        offCtx.drawImage(els.video, 0, 0, vw, vh);
        const img = offCtx.getImageData(0, 0, vw, vh);
        try{
          const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
          if (code && code.data){
            document.getElementById('qrResult').textContent = code.data;
            if (navigator.vibrate) navigator.vibrate(60);
            // 한 번 인식 후에도 계속 스캔하고 싶다면 주석 해제 X
            // stopScan();
          }
        }catch(err){ setError(err); }
      }
      scanRAF = requestAnimationFrame(loop);
    };
    loop();
  }
  
  const btnScanToggle = document.getElementById('btnScanToggle');
  btnScanToggle.addEventListener('click', ()=>{
    if (scanning){ stopScan(); btnScanToggle.textContent='스캔 재개'; }
    else { startScan(); btnScanToggle.textContent='스캔 일시정지'; }
  });
})();
</script>
</body>
</html>
